flowchart TD
    StartPlay([Play函数开始]) --> CheckChs{检查歌曲选择}
    
    subgraph CheckChs [根据Chs选择谱面文件]
        Chs0[Chs=0: 打开0.txt] --> OpenMusic0[打开..\music\0.mp3]
        Chs1[Chs=1: 打开1.txt] --> OpenMusic1[打开..\music\1.mp3]
        Chs2[Chs=2: 打开2.txt] --> OpenMusic2[打开..\music\2.mp3]
        Chs3[Chs=3: 打开3.txt] --> OpenMusic3[打开..\music\3.mp3]
        Chs4[Chs=4: 打开4.txt] --> OpenMusic4[打开..\music\4.mp3]
        Chs5[Chs=5: 打开5.txt] --> OpenMusic5[打开..\music\5.mp3]
        Chs6[Chs=6: 打开6.txt] --> OpenMusic6[打开..\music\6.mp3]
        Chs7[Chs=7: 打开7.txt] --> OpenMusic7[打开..\music\7.mp3]
        Chs8[Chs=8: 打开8.txt] --> OpenMusic8[打开..\music\8.mp3]
        Chs9[Chs=9: 打开9.txt] --> OpenMusic9[无音乐]
        Chs10[Chs=10: 打开10.txt] --> OpenMusic10[无音乐]
        Chs11[Chs=11: 打开11.txt] --> OpenMusic11[无音乐]
    end
    
    CheckChs --> ParseChart[解析谱面数据]
    
    subgraph ParseChart [解析谱面数据]
        PC1[读取速度 spd[Chs]]
        PC2[读取前奏时间 pre[Chs]]
        PC3[读取总时间 Sum]
        PC4[循环读取音符数据]
        PC5[初始化 MTsum 数组]
        PC6[处理长按音符分段]
        PC7[计算总音符数 TOT]
    end
    
    ParseChart --> InitGame[初始化游戏变量]
    
    subgraph InitGame [初始化游戏变量]
        IG1[combo = 0]
        IG2[score = 0]
        IG3[pfct = 0]
        IG4[mxcmb = 0]
        IG5[flsh = 0]
        IG6[ot = 0]
        IG7[设置时间同步变量]
        IG8[设置 cycle_duration = spd[Chs]]
        IG9[设置 next_cycle = 当前时间 + cycle_duration]
    end
    
    InitGame --> DrawGameUI[绘制游戏界面]
    
    subgraph DrawGameUI [绘制游戏界面]
        DUI1[清空控制台]
        DUI2[绘制轨道标题: Q W E R T Y U I]
        DUI3[绘制上轨道边框]
        DUI4[绘制下轨道边框]
        DUI5[绘制按键提示: A S D F G H J K]
        DUI6[显示控制提示: 空格/回车 暂停, ESC 退出]
    end
    
    DrawGameUI --> GameLoop[进入游戏主循环]
    
    subgraph GameLoop [游戏主循环]
        GL1[时间同步控制]
        
        subgraph GL1 [时间同步控制]
            GL1_1[计算时间偏移 offset]
            GL1_2[如果需要, 休眠剩余时间]
            GL1_3[自旋等待直到 next_cycle]
            GL1_4[更新 next_cycle += cycle_duration]
        end
        
        GL1 --> GL2[检测暂停条件]
        
        subgraph GL2 [检测暂停条件]
            GL2_1{按空格/回车/ESC 或<br>失去焦点且非自动播放?}
            GL2_1 -- 是 --> GL3[进入暂停菜单]
            GL2_1 -- 否 --> GL4[继续游戏流程]
        end
        
        GL4 --> GL5[计算当前分数]
        GL5 --> GL6[绘制按键状态]
        
        subgraph GL6 [绘制按键状态]
            GL6_1[遍历所有按键 (1-16)]
            GL6_2{按键被按下或<br>自动播放模拟按下?}
            GL6_2 -- 是 --> GL6_3[高亮显示按键]
            GL6_2 -- 否 --> GL6_4[正常显示按键]
        end
        
        GL6 --> GL7[处理上一帧的Miss]
        
        subgraph GL7 [处理上一帧的Miss]
            GL7_1[遍历 t-1 时刻的所有音符]
            GL7_2{音符未被击中且未处理?}
            GL7_2 -- 是 --> GL7_3[标记为Miss (gt=-1)]
            GL7_3 --> GL7_4[重置连击 combo=0]
            GL7_3 --> GL7_5[绘制Miss效果 'x']
            GL7_2 -- 否 --> GL7_6[跳过处理]
        end
        
        GL7 --> GL8[绘制下落中的音符]
        
        subgraph GL8 [绘制下落中的音符]
            GL8_1[循环 k 从 7 到 1 (上方音符)]
            GL8_2[循环 k 从 1 到 7 (下方音符)]
            GL8_3[遍历 t+k 时刻的音符]
            GL8_4{音符方向?}
            GL8_4 -- 上轨道 --> GL8_5[绘制上方音符]
            GL8_4 -- 下轨道 --> GL8_6[绘制下方音符]
            GL8_5 --> GL8_7[根据类型选择颜色和字符]
            GL8_6 --> GL8_8[根据类型选择颜色和字符]
            GL8_7 --> GL8_9[检查长按状态]
            GL8_8 --> GL8_10[检查长按状态]
        end
        
        GL8 --> GL9[处理当前帧的判定]
        
        subgraph GL9 [处理当前帧的判定]
            GL9_1[遍历 t 时刻的所有音符]
            GL9_2{音符方向?}
            GL9_2 -- 上轨道 --> GL9_3[在上轨道判定线处理]
            GL9_2 -- 下轨道 --> GL9_4[在下轨道判定线处理]
            
            subgraph GL9_3 [上轨道判定线处理]
                GL9_3_1{按键被按下或自动播放?}
                GL9_3_1 -- 是 --> GL9_3_2{音符可判定?}
                GL9_3_2 -- 是 --> GL9_3_3[判定为击中]
                GL9_3_2 -- 否 --> GL9_3_4[判定为过早]
                GL9_3_1 -- 否 --> GL9_3_5[标记为可判定]
            end
            
            subgraph GL9_4 [下轨道判定线处理]
                GL9_4_1{按键被按下或自动播放?}
                GL9_4_1 -- 是 --> GL9_4_2{音符可判定?}
                GL9_4_2 -- 是 --> GL9_4_3[判定为击中]
                GL9_4_2 -- 否 --> GL9_4_4[判定为过早]
                GL9_4_1 -- 否 --> GL9_4_5[标记为可判定]
            end
            
            GL9_3_3 --> GL9_5[处理击中效果]
            GL9_4_3 --> GL9_5
            GL9_3_4 --> GL9_6[处理过早效果]
            GL9_4_4 --> GL9_6
            GL9_3_5 --> GL9_7[处理未按键效果]
            GL9_4_5 --> GL9_7
        end
        
        subgraph GL9_5 [处理击中效果]
            GL9_5_1[绘制击中效果 'O']
            GL9_5_2[播放击中音效]
            GL9_5_3[标记音符为已击中 gt=1]
            GL9_5_4[增加连击数 combo++]
            GL9_5_5[增加完美计数 pfct++]
            GL9_5_6[设置闪烁标志 flsh=2]
            GL9_5_7[设置输出标志 ot=1]
            GL9_5_8[自动播放模式下模拟按键]
        end
        
        subgraph GL9_6 [处理过早效果]
            GL9_6_1[绘制过早效果 'v']
            GL9_6_2[使用白色显示]
        end
        
        subgraph GL9_7 [处理未按键效果]
            GL9_7_1[标记音符为可判定 can=1]
            GL9_7_2{上一帧已Miss?}
            GL9_7_2 -- 是 --> GL9_7_3[绘制Miss效果 'v' (红色)]
            GL9_7_2 -- 否 --> GL9_7_4[绘制普通效果 'v' (紫色)]
        end
        
        GL9 --> GL10[更新游戏状态]
        
        subgraph GL10 [更新游戏状态]
            GL10_1[更新最大连击数 mxcmb = max(mxcmb, combo)]
            GL10_2[计算当前分数 score = (0.9*pfct/TOT + 0.1*mxcmb/TOT)*1000000]
            GL10_3[刷新连击显示]
            GL10_4[刷新分数显示]
            GL10_5[更新闪烁标志 flsh = max(0, flsh-1)]
        end
        
        GL10 --> GL11{是否结束?}
        GL11 -- 否 --> GL1
        GL11 -- 是 --> GL12[退出游戏循环]
    end
    
    subgraph GL3 [暂停菜单处理]
        GL3_1[暂停音乐播放]
        GL3_2[播放暂停音效]
        GL3_3[显示暂停菜单]
        GL3_4[处理菜单导航]
        GL3_5{用户选择?}
        GL3_5 -- 继续 --> GL3_6[恢复音乐播放]
        GL3_5 -- 退出 --> GL3_7[结束游戏]
        GL3_5 -- 重玩 --> GL3_8[重新开始游戏]
        GL3_5 -- 音量 --> GL3_9[进入音量调整]
        GL3_9 --> GL3_3
    end
    
    GL3_6 --> GL2
    GL3_7 --> GL12
    GL3_8 --> ParseChart
    
    GL12 --> EndGame[结束游戏流程]
    
    subgraph EndGame [结束游戏流程]
        EG1[关闭音乐]
        EG2[计算最终成绩]
        EG3[确定评价等级]
        EG4[播放结束音效]
        EG5[显示成绩界面]
        EG6[处理用户选择]
        EG6 -- 返回菜单 --> EG7[返回主菜单]
        EG6 -- 重玩 --> ParseChart
    end
    
    EndGame --> Return[返回主菜单或重新游戏]